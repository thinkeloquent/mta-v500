name: Repository CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_setup:
        description: Run security hardening and scanners
        type: boolean
        default: true
      run_lint:
        description: Run lint suite
        type: boolean
        default: true
      run_build:
        description: Build and push Docker images
        type: boolean
        default: true
      run_deploy:
        description: Deploy the built image
        type: boolean
        default: false
      run_slack:
        description: Send Slack notification
        type: boolean
        default: true
      run_metadata:
        description: Publish build metadata artifacts
        type: boolean
        default: true
      project_orchestration_api:
        description: Include orchestration-api project
        type: boolean
        default: true
      project_reporting_worker:
        description: Include reporting-worker project
        type: boolean
        default: true

permissions:
  contents: read
  packages: write
  id-token: write
  statuses: write

env:
  RUN_SETUP: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_setup || 'true' }}
  RUN_LINT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_lint || 'true' }}
  RUN_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_build || 'true' }}
  RUN_DEPLOY: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy || 'false' }}
  RUN_SLACK: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_slack || 'true' }}
  RUN_METADATA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_metadata || 'true' }}
  DEFAULT_NODE_VERSION: '22'
  DEFAULT_PYTHON_VERSION: '3.11'
  SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL || '' }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN || '' }}

jobs:
  prepare_matrix:
    name: Prepare Project Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
      has_projects: ${{ steps.set_matrix.outputs.has_projects }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build dynamic project matrix
        id: set_matrix
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_PROJECT_ORCHESTRATION_API: ${{ github.event.inputs.project_orchestration_api || 'true' }}
          INPUT_PROJECT_REPORTING_WORKER: ${{ github.event.inputs.project_reporting_worker || 'true' }}
        run: |
          python3 .github/scripts/build_matrix.py

  setup_checks:
    if: env.RUN_SETUP == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@v2
        with:
          disable-sudo: false
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Install security tooling
        run: |
          python -m pip install --upgrade pip
          pip install bandit==1.7.9 safety==3.2.7

      - name: Run safety audit
        run: |
          if [ -f requirements.txt ]; then
            safety check --full-report --continue-on-error
          else
            echo "requirements.txt not found; skipping safety"
          fi

      - name: Run Bandit
        run: |
          if [ -d app ]; then
            bandit -q -r app || true
          else
            echo "app directory not found; skipping bandit"
          fi

      - name: SonarQube scan (conditional)
        if: env.SONAR_HOST_URL != '' && env.SONAR_TOKEN != ''
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >-
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
            -Dsonar.projectKey=${{ github.repository }}

  lint:
    needs: [prepare_matrix, setup_checks]
    if: env.RUN_LINT == 'true' && (needs.setup_checks.result == 'success' || needs.setup_checks.result == 'skipped')
    uses: ./.github/workflows/_reusable-lint.yaml
    with:
      python_version: '3.11'

  build_and_deploy:
    needs:
      - prepare_matrix
      - setup_checks
      - lint
    if: |
      needs.prepare_matrix.outputs.has_projects == 'true' &&
      (env.RUN_BUILD == 'true' || env.RUN_DEPLOY == 'true') &&
      (needs.setup_checks.result == 'success' || needs.setup_checks.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    uses: ./.github/workflows/_reusable-build-deploy.yaml
    with:
      run_build: ${{ fromJson(env.RUN_BUILD) }}
      run_deploy: ${{ fromJson(env.RUN_DEPLOY) }}
      project_matrix: ${{ needs.prepare_matrix.outputs.matrix }}
    secrets:
      ORCHESTRATION_REGISTRY_USER: ${{ secrets.ORCHESTRATION_REGISTRY_USER }}
      ORCHESTRATION_REGISTRY_PASSWORD: ${{ secrets.ORCHESTRATION_REGISTRY_PASSWORD }}
      REPORTING_REGISTRY_USER: ${{ secrets.REPORTING_REGISTRY_USER }}
      REPORTING_REGISTRY_PASSWORD: ${{ secrets.REPORTING_REGISTRY_PASSWORD }}

  notify_slack:
    needs: build_and_deploy
    if: env.RUN_SLACK == 'true' && (needs.build_and_deploy.result == 'success' || needs.build_and_deploy.result == 'skipped') && secrets.SLACK_WEBHOOK_URL != ''
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "CI/CD pipeline for ${{ github.repository }} completed with status: ${{ needs.build_and_deploy.result }} on commit ${{ github.sha }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  publish_metadata:
    needs: build_and_deploy
    if: env.RUN_METADATA == 'true' && (needs.build_and_deploy.result == 'success' || needs.build_and_deploy.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate build metadata
        id: metadata
        run: |
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > build-metadata.json <<'EOF'
          {
            "repository": "${{ github.repository }}",
            "sha": "${{ github.sha }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "event": "${{ github.event_name }}",
            "build_stage_status": "${{ needs.build_and_deploy.result }}",
            "generated_at": "TIMESTAMP_PLACEHOLDER"
          }
          EOF
          sed -i "s/TIMESTAMP_PLACEHOLDER/$ts/" build-metadata.json
          echo "metadata_path=$(pwd)/build-metadata.json" >> "$GITHUB_OUTPUT"

      - name: Upload metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: build-metadata.json
          if-no-files-found: error

      - name: Append metadata to summary
        run: |
          echo '### Build Metadata' >> "$GITHUB_STEP_SUMMARY"
          cat build-metadata.json >> "$GITHUB_STEP_SUMMARY"
