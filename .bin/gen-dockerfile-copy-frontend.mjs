#!/usr/bin/env node
/**
 * Generates RUN cp -rf commands for copying frontend dist folders
 * Usage: node .bin/gen-dockerfile-copy-frontend.mjs
 * Output can be pasted into Dockerfile
 */
import { readdirSync, existsSync } from 'fs';
import { join } from 'path';

const DOCKER_APP_BASE = '/applications';
const DOCKER_DEST_BASE = '/applications/static/app';
const SOURCE_DIRS = ['fastify-apps', 'fastapi-apps'];

const commands = [];
const destDirs = [];

for (const sourceName of SOURCE_DIRS) {
  if (!existsSync(sourceName)) continue;

  for (const appName of readdirSync(sourceName, { withFileTypes: true }).filter(d => d.isDirectory()).map(d => d.name)) {
    const distPath = join(sourceName, appName, 'frontend', 'dist');
    if (existsSync(distPath)) {
      const cleanName = appName.replace(/^app-/, '');
      const src = `${DOCKER_APP_BASE}/${sourceName}/${appName}/frontend/dist`;
      const dest = `${DOCKER_DEST_BASE}/${cleanName}/dist`;
      destDirs.push(`${DOCKER_DEST_BASE}/${cleanName}`);
      commands.push(`RUN cp -rf ${src} ${dest}`);
    }
  }
}

if (commands.length) {
  console.log(`# Generated by: node .bin/gen-dockerfile-copy-frontend.mjs`);
  console.log(`RUN mkdir -p ${destDirs.join(' \\\n  ')}\n`);
  console.log(commands.join('\n'));
} else {
  console.log('# No frontend/dist directories found');
}
